<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAG Sample Demo</title>
    <style>
      body { font-family: system-ui, Arial; max-width: 900px; margin: 24px auto; padding: 0 16px; }
      textarea { width: 100%; height: 80px; }
      pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto }
      .result { border:1px solid #eee; padding:8px; margin:8px 0; border-radius:6px }
    </style>
  </head>
  <body>
    <h1>RAG Sample Demo</h1>
    <p>Enter a question and click <strong>Ask</strong>. This demo sends your query to <code>/query</code> and shows retrieved contexts and a synthesized answer.</p>

    <label>Question</label>
    <textarea id="q">How do I use the template?</textarea>

    <label>Top-k</label>
    <input id="k" type="number" value="3" min="1" max="20" />

    <div style="margin-top:12px">
      <button id="ask">Ask</button>
      <span id="status" style="margin-left:12px;color:#666"></span>
    </div>

    <h2>Answer</h2>
    <pre id="answer">(no answer yet)</pre>

    <h2>Retrieved</h2>
    <div id="retrieved"></div>

    <script>
      const ask = document.getElementById('ask')
      const status = document.getElementById('status')
      const qEl = document.getElementById('q')
      const kEl = document.getElementById('k')
      const answerEl = document.getElementById('answer')
      const retrievedEl = document.getElementById('retrieved')

      async function doQuery() {
        status.textContent = 'sending...'
        answerEl.textContent = ''
        retrievedEl.innerHTML = ''
        try {
          const body = { q: qEl.value, k: parseInt(kEl.value || '3', 10) }
          const resp = await fetch('/query', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
          if (!resp.ok) {
            const err = await resp.text()
            status.textContent = 'error'
            answerEl.textContent = err
            return
          }
          const data = await resp.json()
          status.textContent = 'ok'
          answerEl.textContent = data.answer || '(no answer)'
          if (Array.isArray(data.results)) {
            data.results.forEach(r => {
              const d = document.createElement('div')
              d.className = 'result'
              d.innerHTML = `<strong>${r.id}</strong> <em>(score: ${Number(r.score).toFixed(3)})</em><div><pre>${escapeHtml(r.text)}</pre></div>`
              retrievedEl.appendChild(d)
            })
          }
        } catch (e) {
          status.textContent = 'error'
          answerEl.textContent = String(e)
        }
      }

      function escapeHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      }

      ask.addEventListener('click', doQuery)
    </script>
  </body>
</html>
