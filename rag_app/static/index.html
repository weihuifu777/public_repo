
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>RAG Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --ercot-blue: #003087;      /* ERCOT primary blue */
      --ercot-light-blue: #0066cc;
      --ercot-dark-blue: #002060;
      --bg: #f5f5f5;              /* Light gray background */
      --panel: #ffffff;           /* White panels */
      --text: #333333;            /* Dark gray text */
      --muted: #666666;           /* Muted gray */
      --accent: #0066cc;          /* ERCOT blue accent */
      --accent-d: #003087;        /* Darker blue */
      --ok: #28a745;              /* Green for success */
      --err: #dc3545;             /* Red for errors */
      --border: #dddddd;          /* Light border */
      --input-bg: #ffffff;        /* Input background */
      --result-bg: #f8f9fa;       /* Result item background */
      --result-hover: #e9ecef;    /* Result item hover */
      --code-bg: rgba(0, 48, 135, 0.1);  /* Code background */
      --mark-bg: #fff3cd;         /* Highlight background */
      --mark-text: #856404;       /* Highlight text */
    }
    
    /* Dark theme */
    [data-theme="dark"] {
      --ercot-blue: #4d94ff;
      --ercot-light-blue: #66a3ff;
      --ercot-dark-blue: #3385ff;
      --bg: #1a1a2e;
      --panel: #16213e;
      --text: #e8e8e8;
      --muted: #a0a0a0;
      --accent: #4d94ff;
      --accent-d: #3385ff;
      --ok: #4ade80;
      --err: #f87171;
      --border: #2d3748;
      --input-bg: #1e2a47;
      --result-bg: #1e2a47;
      --result-hover: #283555;
      --code-bg: rgba(77, 148, 255, 0.15);
      --mark-bg: #4d3800;
      --mark-text: #ffd966;
    }
    
    [data-theme="dark"] .ercot-header {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    
    [data-theme="dark"] input[type="text"],
    [data-theme="dark"] select,
    [data-theme="dark"] input[type="number"] {
      background: var(--input-bg);
      color: var(--text);
      border-color: var(--border);
    }
    
    [data-theme="dark"] input[type="text"]::placeholder {
      color: #666;
    }
    
    [data-theme="dark"] button {
      background: linear-gradient(180deg, var(--ercot-light-blue), var(--ercot-blue));
    }
    
    [data-theme="dark"] button:hover {
      background: linear-gradient(180deg, var(--ercot-blue), var(--ercot-dark-blue));
    }
    
    [data-theme="dark"] button.secondary {
      background: var(--panel);
      color: var(--accent);
      border-color: var(--border);
    }
    
    [data-theme="dark"] button.secondary:hover {
      background: var(--result-bg);
      border-color: var(--accent);
    }
    
    [data-theme="dark"] .status {
      background: var(--result-bg);
    }
    
    [data-theme="dark"] .status.ok {
      background: rgba(74, 222, 128, 0.15);
      border-left-color: var(--ok);
    }
    
    [data-theme="dark"] .status.err {
      background: rgba(248, 113, 113, 0.15);
      border-left-color: var(--err);
    }
    
    [data-theme="dark"] .results {
      background: var(--panel);
      border-color: var(--border);
    }
    
    [data-theme="dark"] .result-item {
      background: var(--result-bg);
      border-left-color: var(--accent);
    }
    
    [data-theme="dark"] .result-item:hover {
      background: var(--result-hover);
    }
    
    [data-theme="dark"] .result-item.collapsed .result-text {
      background: var(--panel);
    }
    
    [data-theme="dark"] .collapse-toggle {
      background: var(--panel);
      border-color: var(--border);
    }
    
    [data-theme="dark"] .collapse-toggle:hover {
      background: var(--result-hover);
    }
    
    [data-theme="dark"] .collapse-all-controls button {
      background: var(--panel);
      border-color: var(--border);
      color: var(--text);
    }
    
    [data-theme="dark"] .collapse-all-controls button:hover {
      background: var(--result-hover);
    }
    
    [data-theme="dark"] .result-text mark {
      background: var(--mark-bg);
      color: var(--mark-text);
    }
    
    [data-theme="dark"] .pagination {
      background: var(--result-bg);
      border-color: var(--border);
    }
    
    [data-theme="dark"] .pagination button:disabled {
      background: var(--panel);
      color: var(--muted);
    }
    
    [data-theme="dark"] .help-section {
      background: linear-gradient(135deg, #1e2a47 0%, #16213e 100%);
      border-color: var(--border);
    }
    
    [data-theme="dark"] .help-desc code {
      background: var(--code-bg);
      color: var(--accent);
    }
    
    [data-theme="dark"] .footer {
      background: var(--panel);
      border-top-color: var(--border);
    }
    
    /* Theme toggle button */
    .theme-toggle {
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.2s;
      min-width: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }
    .theme-toggle .theme-icon {
      font-size: 1.2rem;
    }
    .theme-toggle .theme-label {
      font-size: 0.85rem;
      font-weight: 500;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    .ercot-header {
      background: linear-gradient(135deg, var(--ercot-dark-blue) 0%, var(--ercot-blue) 100%);
      color: white;
      padding: 1rem 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .ercot-header .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .ercot-logo {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: white;
    }
    .ercot-title {
      font-size: 1.1rem;
      font-weight: 300;
      opacity: 0.95;
    }
    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .rebuild-btn {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s;
      min-width: auto;
    }
    .rebuild-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }
    .rebuild-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .rebuild-btn.rebuilding {
      background: rgba(255, 200, 0, 0.3);
      border-color: rgba(255, 200, 0, 0.5);
    }
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }
    header {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid var(--ercot-blue);
    }
    h1 {
      margin: 0 0 .25rem 0;
      font-size: 1.75rem;
      letter-spacing: 0.5px;
      color: var(--ercot-blue);
      font-weight: 600;
    }
    .subtitle {
      color: var(--muted);
      font-size: 0.95rem;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: .75rem;
      margin-top: .5rem;
    }
    input[type="text"], select, input[type="number"] {
      width: 100%;
      padding: .7rem .8rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      outline: none;
      font-size: 0.95rem;
    }
    input[type="text"]:focus, select:focus, input[type="number"]:focus {
      border-color: var(--ercot-blue);
      box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1);
    }
    input[type="text"]::placeholder { color: #999; }
    button {
      padding: .75rem 1.25rem;
      border-radius: 4px;
      border: none;
      background: linear-gradient(180deg, var(--ercot-light-blue), var(--ercot-blue));
      color: white;
      cursor: pointer;
      font-weight: 600;
      min-width: 120px;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    button:hover {
      background: linear-gradient(180deg, var(--ercot-blue), var(--ercot-dark-blue));
      box-shadow: 0 2px 6px rgba(0, 48, 135, 0.3);
    }
    button.secondary {
      border: 1px solid var(--border);
      background: white;
      color: var(--ercot-blue);
    }
    button.secondary:hover {
      background: #f8f9fa;
      border-color: var(--ercot-blue);
    }
    .opts {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: .75rem;
    }
    .status {
      margin-top: .5rem;
      font-size: .9rem;
      color: var(--muted);
      padding: 0.5rem;
      border-radius: 4px;
      background: #f8f9fa;
    }
    .status.ok { 
      color: var(--ok); 
      background: #d4edda;
      border-left: 3px solid var(--ok);
    }
    .status.err { 
      color: var(--err);
      background: #f8d7da;
      border-left: 3px solid var(--err);
    }
    .results {
      margin-top: 1rem;
      line-height: 1.5;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      overflow-x: auto;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .results pre {
      white-space: pre-wrap;
      margin: 0;
    }
    .search-header {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--ercot-blue);
      color: var(--ercot-blue);
      font-weight: 600;
    }
    .result-item {
      margin-bottom: 0.5rem;
      padding: 0.75rem;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid var(--ercot-blue);
      transition: all 0.2s;
    }
    .result-item:hover {
      background: #e9ecef;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    
    /* Collapsible result styles */
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 0.5rem;
    }
    .result-header-content {
      flex: 1;
    }
    .collapse-toggle {
      background: #e9ecef;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--text);
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .collapse-toggle:hover {
      background: #dee2e6;
    }
    .result-item .result-text {
      max-height: 500px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease-out, opacity 0.3s ease-out;
    }
    .result-item.collapsed .result-text {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
      opacity: 0;
    }
    .result-item.collapsed {
      padding-bottom: 0.5rem;
    }
    .collapse-all-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      justify-content: flex-end;
    }
    .collapse-all-controls button {
      background: #e9ecef;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.4rem 0.75rem;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--text);
      transition: all 0.2s;
    }
    .collapse-all-controls button:hover {
      background: #dee2e6;
    }
    .result-file {
      margin-bottom: 0.5rem;
    }
    .result-file a {
      color: var(--ercot-blue);
      text-decoration: none;
      font-weight: 600;
    }
    .result-file a:hover {
      text-decoration: underline;
      color: var(--ercot-dark-blue);
    }
    .result-location {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .pdf-link {
      margin-left: 0.75rem;
      padding: 0.25rem 0.5rem;
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white !important;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .pdf-link:hover {
      background: linear-gradient(135deg, #c82333 0%, #a71d2a 100%);
      text-decoration: none !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .result-text {
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.9rem;
      color: var(--text);
      word-break: break-word;
    }
    .result-text mark {
      background: #fff3cd;
      color: #856404;
      padding: 2px 4px;
      border-radius: 2px;
      font-weight: 500;
    }
    .footer {
      margin-top: 3rem;
      padding: 2rem 0;
      color: var(--muted);
      font-size: .85rem;
      border-top: 1px solid var(--border);
      background: white;
    }
    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }
    .list {
      margin: .5rem 0 1rem 0;
      padding-left: 1.5rem;
    }
    .list li {
      margin: .25rem 0;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin: 1.5rem 0;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .pagination button {
      padding: 0.5rem 1rem;
      min-width: 90px;
      font-size: 0.9rem;
    }
    .pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: #e9ecef;
      color: #6c757d;
    }
    .pagination .page-info {
      color: var(--text);
      font-weight: 600;
      margin: 0 1rem;
    }
    /* Help Section Styles */
    .help-section {
      margin-top: 1rem;
      background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
      border: 1px solid var(--ercot-light-blue);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 48, 135, 0.1);
    }
    .help-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, var(--ercot-blue) 0%, var(--ercot-light-blue) 100%);
      color: white;
    }
    .help-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      min-width: auto;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .help-close:hover {
      background: rgba(255,255,255,0.3);
    }
    .help-content {
      padding: 1rem;
    }
    .help-item {
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(0, 102, 204, 0.15);
    }
    .help-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .help-label {
      font-weight: 600;
      color: var(--ercot-blue);
      margin-bottom: 0.25rem;
    }
    .help-desc {
      color: var(--text);
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .help-desc code {
      background: rgba(0, 48, 135, 0.1);
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      font-family: 'Consolas', monospace;
      font-size: 0.85rem;
      color: var(--ercot-blue);
    }
    .help-desc ul {
      list-style-type: disc;
    }
    .help-desc li {
      margin: 0.25rem 0;
    }
    #btnHelp {
      min-width: 40px;
      padding: 0.75rem;
      font-size: 1rem;
    }
    
    /* Search History Styles */
    .search-history-container {
      position: relative;
    }
    .search-history {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--panel);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .search-history.show {
      display: block;
    }
    .search-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background: var(--result-bg);
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--muted);
    }
    .search-history-clear {
      background: none;
      border: none;
      color: var(--err);
      cursor: pointer;
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      min-width: auto;
    }
    .search-history-clear:hover {
      background: rgba(220, 53, 69, 0.1);
    }
    .search-history-item {
      padding: 0.6rem 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.15s;
    }
    .search-history-item:last-child {
      border-bottom: none;
    }
    .search-history-item:hover {
      background: var(--result-bg);
    }
    .search-history-item .history-icon {
      color: var(--muted);
      font-size: 0.9rem;
    }
    .search-history-item .history-query {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text);
    }
    .search-history-item .history-time {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .search-history-item .history-delete {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0.2rem;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.15s;
      min-width: auto;
    }
    .search-history-item:hover .history-delete {
      opacity: 1;
    }
    .search-history-item .history-delete:hover {
      color: var(--err);
    }
    .search-history-empty {
      padding: 1rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.9rem;
    }
    #btnHistory {
      min-width: 40px;
      padding: 0.75rem;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div class="ercot-header">
    <div class="header-content">
      <div class="ercot-logo">ERCOT</div>
      <div class="ercot-title">ERCOT Internal Knowledge Base Tool</div>
      <div class="header-actions">
        <button class="theme-toggle" id="btnTheme" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
          <span class="theme-icon">üåô</span>
          <span class="theme-label">Dark</span>
        </button>
        <button class="rebuild-btn" id="btnRebuild" onclick="rebuildIndex()">üîÑ Rebuild Index</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <header>
      <h1>Document Search & Analysis</h1>
      <div class="subtitle">Electric Reliability Council of Texas - Internal Knowledge Base</div>
    </header>

    <div class="card">
      <form id="searchForm">
        <div class="row">
          <div class="search-history-container" style="flex:1">
            <input id="query" type="text" placeholder="Ask something‚Ä¶" required autocomplete="off" />
            <div id="searchHistory" class="search-history"></div>
          </div>
          <div style="display:flex; gap:.5rem">
            <button type="submit" id="btnSearch">Search</button>
            <button type="button" class="secondary" id="btnHistory" onclick="toggleSearchHistory()" title="Search History">üïê</button>
            <button type="button" class="secondary" id="btnLucky">I'm Feeling Lucky</button>
            <button type="button" class="secondary" id="btnClear" onclick="clearResults()" title="Clear Results">üóëÔ∏è Clear</button>
            <button type="button" class="secondary" id="btnHelp" onclick="toggleHelp()" title="Show Help">‚ùì</button>
          </div>
        </div>

        <!-- Help Section -->
        <div id="helpSection" class="help-section" style="display:none">
          <div class="help-header">
            <strong>üîç Search Parameters Help</strong>
            <button type="button" class="help-close" onclick="toggleHelp()">‚úï</button>
          </div>
          <div class="help-content">
            <div class="help-item">
              <div class="help-label">Search Query</div>
              <div class="help-desc">Enter keywords, phrases, or questions to search across all indexed documents. The search is case-insensitive. Examples: <code>RPC error</code>, <code>HABITAT plugin</code>, <code>connection timeout</code></div>
            </div>
            <div class="help-item">
              <div class="help-label">Provider</div>
              <div class="help-desc">
                <ul style="margin:0.25rem 0 0 1rem; padding:0;">
                  <li><strong>simple</strong> - Fast text search across all documents (recommended, no API needed)</li>
                  <li><strong>openai</strong> - AI-powered answers using GPT-3.5 (requires OPENAI_API_KEY)</li>
                  <li><strong>local</strong> - Offline AI using llama.cpp (requires model download)</li>
                  <li><strong>gpt4all</strong> - Offline AI using GPT4All (requires model download)</li>
                </ul>
              </div>
            </div>
            <div class="help-item">
              <div class="help-label">Results per page</div>
              <div class="help-desc">Number of search results to display on each page (1-50). Use pagination buttons to navigate through all results.</div>
            </div>
            <div class="help-item">
              <div class="help-label">Index Path (optional)</div>
              <div class="help-desc">Advanced: Specify a custom index file path. Leave blank to use the default server index (<code>data/index.joblib</code>). Only use this if you have multiple index files.</div>
            </div>
            <div class="help-item">
              <div class="help-label">I'm Feeling Lucky</div>
              <div class="help-desc">Click to auto-fill a random sample search query for quick testing.</div>
            </div>
            <div class="help-item">
              <div class="help-label">üîÑ Rebuild Index</div>
              <div class="help-desc">Click the button in the header to rebuild the search index after adding new files to the <code>data/</code> folder.</div>
            </div>
          </div>
        </div>

        <div class="opts" style="margin-top:.75rem">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem">
            <div>
              <label for="provider" style="display:block; margin-bottom:.25rem; color: var(--muted)">Provider</label>
              <select id="provider">
                <option value="simple" selected>simple (local synthesizer)</option>
                <option value="openai">openai (requires OPENAI_API_KEY)</option>
                <option value="local">local (llama-cpp)</option>
                <option value="gpt4all">gpt4all</option>
              </select>
            </div>
            <div>
              <label for="topk" style="display:block; margin-bottom:.25rem; color: var(--muted)">Results per page</label>
              <input id="topk" type="number" min="1" max="50" value="10" />
            </div>
          </div>
          <div>
            <label for="indexPath" style="display:block; margin-bottom:.25rem; color: var(--muted)">Index Path (optional)</label>
            <input id="indexPath" type="text" placeholder="Leave blank to use server's default index" />
          </div>
        </div>

        <div id="status" class="status">Checking server‚Ä¶</div>
      </form>

      <div id="results" class="results" hidden></div>
    </div>

    <div class="footer">
      <div class="footer-content">
        <p><strong>ERCOT Document Search Tool</strong> - A RAG-powered search system for internal documentation</p>
        <ul class="list">
          <li>Submit queries to <code>POST /query</code> on the same origin</li>
          <li>Backend health reports <code>index_loaded: true</code> when ready</li>
          <li><strong>NOTE: Data is confidential. Please do not share externally.</strong></li>
        </ul>
        <p style="margin-top: 1rem; font-size: 0.8rem; color: #999;">
          ¬© 2026 Electric Reliability Council of Texas, Inc. All rights reserved.
        </p>
      </div>
    </div>
  </div>

  <script>
    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('rag-theme') || 'light';
      setTheme(savedTheme);
    }
    
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('rag-theme', theme);
      updateThemeButton(theme);
    }
    
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    }
    
    function updateThemeButton(theme) {
      const btn = document.getElementById('btnTheme');
      if (!btn) return;
      const icon = btn.querySelector('.theme-icon');
      const label = btn.querySelector('.theme-label');
      if (theme === 'dark') {
        icon.textContent = '‚òÄÔ∏è';
        label.textContent = 'Light';
        btn.title = 'Switch to Light Mode';
      } else {
        icon.textContent = 'üåô';
        label.textContent = 'Dark';
        btn.title = 'Switch to Dark Mode';
      }
    }
    
    // Initialize theme on page load
    initTheme();
    
    // Search History Management
    const HISTORY_KEY = 'rag-search-history';
    const MAX_HISTORY = 20;
    
    function getSearchHistory() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      } catch {
        return [];
      }
    }
    
    function saveSearchHistory(history) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }
    
    function addToHistory(query) {
      const q = query.trim();
      if (!q) return;
      
      let history = getSearchHistory();
      // Remove duplicate if exists
      history = history.filter(item => item.query.toLowerCase() !== q.toLowerCase());
      // Add new entry at the beginning
      history.unshift({
        query: q,
        timestamp: Date.now()
      });
      // Keep only MAX_HISTORY items
      history = history.slice(0, MAX_HISTORY);
      saveSearchHistory(history);
    }
    
    function removeFromHistory(index) {
      let history = getSearchHistory();
      history.splice(index, 1);
      saveSearchHistory(history);
      renderSearchHistory();
    }
    
    function clearSearchHistory() {
      localStorage.removeItem(HISTORY_KEY);
      renderSearchHistory();
    }
    
    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      return new Date(timestamp).toLocaleDateString();
    }
    
    function renderSearchHistory() {
      const container = document.getElementById('searchHistory');
      const history = getSearchHistory();
      
      if (history.length === 0) {
        container.innerHTML = '<div class="search-history-empty">No search history yet</div>';
        return;
      }
      
      let html = `
        <div class="search-history-header">
          <span>üïê Recent Searches (${history.length})</span>
          <button type="button" class="search-history-clear" onclick="clearSearchHistory()">Clear All</button>
        </div>
      `;
      
      history.forEach((item, index) => {
        html += `
          <div class="search-history-item" onclick="selectHistoryItem('${escapeHtml(item.query.replace(/'/g, "\\'"))}')">
            <span class="history-icon">üîç</span>
            <span class="history-query">${escapeHtml(item.query)}</span>
            <span class="history-time">${formatTimeAgo(item.timestamp)}</span>
            <button type="button" class="history-delete" onclick="event.stopPropagation(); removeFromHistory(${index})" title="Remove">‚úï</button>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function selectHistoryItem(query) {
      document.getElementById('query').value = query;
      hideSearchHistory();
      document.getElementById('searchForm').dispatchEvent(new Event('submit'));
    }
    
    function toggleSearchHistory() {
      const container = document.getElementById('searchHistory');
      if (container.classList.contains('show')) {
        hideSearchHistory();
      } else {
        showSearchHistory();
      }
    }
    
    function showSearchHistory() {
      renderSearchHistory();
      document.getElementById('searchHistory').classList.add('show');
    }
    
    function hideSearchHistory() {
      document.getElementById('searchHistory').classList.remove('show');
    }

    // Close history when clicking outside
    document.addEventListener('click', (e) => {
      const container = document.getElementById('searchHistory');
      const historyBtn = document.getElementById('btnHistory');
      const queryInput = document.getElementById('query');
      if (!container.contains(e.target) && e.target !== historyBtn && e.target !== queryInput) {
        hideSearchHistory();
      }
    });

    // Collapsible Results Functions
    function toggleResultCollapse(btn) {
      const resultItem = btn.closest('.result-item');
      if (resultItem.classList.contains('collapsed')) {
        resultItem.classList.remove('collapsed');
        btn.textContent = '‚ñ≤ Collapse';
        btn.title = 'Collapse this result';
      } else {
        resultItem.classList.add('collapsed');
        btn.textContent = '‚ñº Expand';
        btn.title = 'Expand this result';
      }
    }

    function collapseAllResults() {
      const results = document.querySelectorAll('.result-item');
      results.forEach(item => {
        item.classList.add('collapsed');
        const btn = item.querySelector('.collapse-toggle');
        if (btn) {
          btn.textContent = '‚ñº Expand';
          btn.title = 'Expand this result';
        }
      });
    }

    function expandAllResults() {
      const results = document.querySelectorAll('.result-item');
      results.forEach(item => {
        item.classList.remove('collapsed');
        const btn = item.querySelector('.collapse-toggle');
        if (btn) {
          btn.textContent = '‚ñ≤ Collapse';
          btn.title = 'Collapse this result';
        }
      });
    }

    // Make result items collapsible by wrapping content
    function makeResultsCollapsible(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const resultItems = doc.querySelectorAll('.result-item');
      
      resultItems.forEach((item, index) => {
        // Find the file info and text content
        const fileDiv = item.querySelector('.result-file');
        const textDiv = item.querySelector('.result-text');
        
        if (fileDiv && textDiv) {
          // Create header wrapper
          const header = document.createElement('div');
          header.className = 'result-header';
          
          const headerContent = document.createElement('div');
          headerContent.className = 'result-header-content';
          headerContent.appendChild(fileDiv.cloneNode(true));
          
          const toggleBtn = document.createElement('button');
          toggleBtn.className = 'collapse-toggle';
          toggleBtn.textContent = '‚ñ≤ Collapse';
          toggleBtn.title = 'Collapse this result';
          toggleBtn.onclick = function() { toggleResultCollapse(this); };
          
          header.appendChild(headerContent);
          header.appendChild(toggleBtn);
          
          // Replace original file div with header
          fileDiv.parentNode.replaceChild(header, fileDiv);
        }
      });
      
      // Add collapse all controls at the beginning if there are results
      if (resultItems.length > 1) {
        const controlsHtml = `<div class="collapse-all-controls">
          <button onclick="expandAllResults()" title="Expand all results">üìñ Expand All</button>
          <button onclick="collapseAllResults()" title="Collapse all results">üìï Collapse All</button>
        </div>`;
        return controlsHtml + doc.body.innerHTML;
      }
      
      return doc.body.innerHTML;
    }

    // If you serve this page from a different origin, set API_BASE to that URL.
    const API_BASE = ''; // '' means same origin, e.g., http://localhost:8000

    const els = {
      form: document.getElementById('searchForm'),
      query: document.getElementById('query'),
      provider: document.getElementById('provider'),
      topk: document.getElementById('topk'),
      indexPath: document.getElementById('indexPath'),
      btnSearch: document.getElementById('btnSearch'),
      btnLucky: document.getElementById('btnLucky'),
      btnRebuild: document.getElementById('btnRebuild'),
      btnHistory: document.getElementById('btnHistory'),
      status: document.getElementById('status'),
      results: document.getElementById('results')
    };
    
    // Pagination state
    let currentPage = 1;
    let currentData = null;

    async function rebuildIndex() {
      const btn = els.btnRebuild;
      btn.disabled = true;
      btn.classList.add('rebuilding');
      btn.textContent = '‚è≥ Rebuilding...';
      
      showStatus('Rebuilding index... This may take a moment.');
      
      try {
        const resp = await fetch(`${API_BASE}/rebuild-index`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!resp.ok) {
          const errText = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${errText}`);
        }
        
        const data = await resp.json();
        showStatus(`‚úÖ Index rebuilt successfully! ${data.num_documents} documents indexed.`, 'ok');
        
        // Refresh health check
        setTimeout(health, 1000);
      } catch (e) {
        showStatus(`‚ùå Rebuild failed: ${e.message}`, 'err');
      } finally {
        btn.disabled = false;
        btn.classList.remove('rebuilding');
        btn.textContent = 'üîÑ Rebuild Index';
      }
    }

    function showStatus(text, type='') {
      els.status.textContent = text;
      els.status.className = `status ${type}`;
    }
    function showResults(data, page = 1) {
      currentData = data;
      currentPage = page;
      
      const provider = els.provider.value || 'simple';
      const per_page = parseInt(els.topk.value || '10', 10);
      let answer = data.answer || '(no answer)';
      let pagination = data.pagination || {};
      
      // Check if answer contains HTML (from simple provider)
      const isHtml = answer.includes('<div class="search-header">') || answer.includes('<div class="result-item">');
      
      let content = '';
      
      // For simple provider with HTML results, paginate the HTML content
      if (provider === 'simple' && isHtml) {
        // Parse HTML to extract header and results
        const parser = new DOMParser();
        const doc = parser.parseFromString(answer, 'text/html');
        const headerDiv = doc.querySelector('.search-header');
        const resultItems = Array.from(doc.querySelectorAll('.result-item'));
        
        // Store all results for pagination
        if (!currentData.htmlResults) {
          currentData.htmlResults = resultItems;
          currentData.htmlHeader = headerDiv ? headerDiv.outerHTML : '';
        }
        
        const totalResults = resultItems.length;
        const totalPages = Math.ceil(totalResults / per_page);
        const validPage = Math.max(1, Math.min(page, totalPages));
        
        // Calculate pagination
        const startIdx = (validPage - 1) * per_page;
        const endIdx = startIdx + per_page;
        const pageResults = resultItems.slice(startIdx, endIdx);
        
        // Add pagination info header
        content += `<div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border-left: 3px solid var(--accent);">`;
        content += `<strong>Showing results ${startIdx + 1}-${Math.min(endIdx, totalResults)} of ${totalResults}</strong> (Page ${validPage} of ${totalPages})`;
        content += `</div>`;
        
        // Show header and paginated results
        content += currentData.htmlHeader;
        content += pageResults.map(item => item.outerHTML).join('');
        
        // Apply collapsible functionality
        content = makeResultsCollapsible(content);
        
        // Add pagination controls
        if (totalPages > 1) {
          content += '<div class="pagination">';
          content += `<button onclick="goToPageSimple(1)" ${validPage === 1 ? 'disabled' : ''} title="First Page">‚èÆ First</button>`;
          content += `<button onclick="goToPageSimple(${validPage - 1})" ${validPage === 1 ? 'disabled' : ''} title="Previous Page">‚óÄ Previous</button>`;
          content += `<span class="page-info">Page ${validPage} of ${totalPages}</span>`;
          content += `<button onclick="goToPageSimple(${validPage + 1})" ${validPage === totalPages ? 'disabled' : ''} title="Next Page">Next ‚ñ∂</button>`;
          content += `<button onclick="goToPageSimple(${totalPages})" ${validPage === totalPages ? 'disabled' : ''} title="Last Page">Last ‚è≠</button>`;
          content += '</div>';
        }
        
        els.results.innerHTML = content;
        els.results.hidden = false;
        return;
      }
      
      // Original logic for non-simple providers
      // Add pagination info header
      if (pagination.total_results > 0) {
        const start = (pagination.current_page - 1) * pagination.per_page + 1;
        const end = Math.min(start + pagination.per_page - 1, pagination.total_results);
        content += `<div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border-left: 3px solid var(--accent);">`;
        content += `<strong>Showing results ${start}-${end} of ${pagination.total_results}</strong> (Page ${pagination.current_page} of ${pagination.total_pages})`;
        content += `</div>`;
      }
      
      // Show top results summary for non-simple providers
      if (provider !== 'simple' || !isHtml) {
        const lines = ['<pre>Top results on this page:'];
        for (const r of (data.results || [])) {
          const score = (typeof r.score === 'number') ? r.score.toFixed(3) : String(r.score);
          lines.push(`- ${r.id} (score=${score})`);
        }
        lines.push('\n==== ANSWER ====\n');
        content += lines.join('\n') + '</pre>';
      }
      
      // Render answer as HTML if it contains HTML tags, otherwise as text
      if (isHtml) {
        content += answer;
        // Apply collapsible functionality for HTML content
        content = makeResultsCollapsible(content);
      } else {
        content += `<pre>${escapeHtml(answer)}</pre>`;
      }
      
      // Add pagination controls
      if (pagination.total_pages > 1) {
        content += '<div class="pagination">';
        content += `<button onclick="goToPage(1)" ${pagination.current_page === 1 ? 'disabled' : ''} title="First Page">‚èÆ First</button>`;
        content += `<button onclick="goToPage(${pagination.current_page - 1})" ${pagination.current_page === 1 ? 'disabled' : ''} title="Previous Page">‚óÄ Previous</button>`;
        content += `<span class="page-info">Page ${pagination.current_page} of ${pagination.total_pages}</span>`;
        content += `<button onclick="goToPage(${pagination.current_page + 1})" ${pagination.current_page === pagination.total_pages ? 'disabled' : ''} title="Next Page">Next ‚ñ∂</button>`;
        content += `<button onclick="goToPage(${pagination.total_pages})" ${pagination.current_page === pagination.total_pages ? 'disabled' : ''} title="Last Page">Last ‚è≠</button>`;
        content += '</div>';
      }
      
      els.results.innerHTML = content;
      els.results.hidden = false;
    }
    
    function goToPageSimple(page) {
      if (!currentData) return;
      showResults(currentData, page);
      // Scroll to top of results
      els.results.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function goToPage(page) {
      if (!currentData || !currentData.pagination) return;
      if (page < 1 || page > currentData.pagination.total_pages) return;
      
      // Recalculate which results to show on this page
      const per_page = currentData.pagination.per_page;
      const start_idx = (page - 1) * per_page;
      const end_idx = start_idx + per_page;
      const page_results = currentData.all_results.slice(start_idx, end_idx);
      
      // Update pagination info
      const updatedData = {
        ...currentData,
        results: page_results,
        pagination: {
          ...currentData.pagination,
          current_page: page
        }
      };
      
      showResults(updatedData, page);
      // Scroll to top of results
      els.results.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Toggle help section visibility
    function toggleHelp() {
      const helpSection = document.getElementById('helpSection');
      const btnHelp = document.getElementById('btnHelp');
      if (helpSection.style.display === 'none') {
        helpSection.style.display = 'block';
        btnHelp.title = 'Hide Help';
        btnHelp.textContent = '‚ùå';
      } else {
        helpSection.style.display = 'none';
        btnHelp.title = 'Show Help';
        btnHelp.textContent = '‚ùì';
      }
    }

    // Clear search results and reset form
    function clearResults() {
      els.results.innerHTML = '';
      els.results.hidden = true;
      els.query.value = '';
      currentData = null;
      showStatus('Results cleared.', 'ok');
      els.query.focus();
    }

    async function health() {
      try {
        const resp = await fetch(`${API_BASE}/health`);
        const data = await resp.json();
        if (data.index_loaded) {
          showStatus('Server ready. Index loaded.', 'ok');
        } else {
          showStatus('Server running, but index NOT loaded. Rebuild or set RAG_INDEX_PATH.', 'err');
        }
      } catch (e) {
        showStatus(`Health check failed: ${e.message}`, 'err');
      }
    }

    async function runQuery(q, page = 1) {
      const per_page = parseInt(els.topk.value || '10', 10);
      const provider = els.provider.value || 'simple';
      const index_path = els.indexPath.value.trim();
      const payload = { q, per_page, page, provider };
      if (index_path) payload.index_path = index_path;

      showStatus('Searching‚Ä¶');
      els.results.hidden = true;
      try {
        const resp = await fetch(`${API_BASE}/query`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          const errText = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${errText}`);
        }
        const data = await resp.json();
        showStatus('Done', 'ok');
        showResults(data);
      } catch (e) {
        showStatus(`Error: ${e.message}`, 'err');
      }
    }

    // Wire up events
    els.form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = els.query.value.trim();
      if (!q) return;
      await runQuery(q);
      addToHistory(q);
      hideSearchHistory();
    });
    els.btnLucky.addEventListener('click', async () => {
      const samples = [
        'RPC',
        'ERROR',
        'WARN',
        'plugin',
        'HABITAT',
        'client handle',
        'ERCOT',
        'database'
      ];
      els.query.value = samples[Math.floor(Math.random() * samples.length)];
      els.form.dispatchEvent(new Event('submit'));
    });

    // Search history events
    els.btnHistory.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleSearchHistory();
    });

    els.query.addEventListener('focus', () => {
      const history = getSearchHistory();
      if (history.length > 0) {
        showSearchHistory();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const container = document.querySelector('.search-history-container');
      if (container && !container.contains(e.target)) {
        hideSearchHistory();
      }
    });

    // Initial
    health();
  </script>
</body>
</html>
